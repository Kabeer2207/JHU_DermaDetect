<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Diagnosis Results - Skin Health Center</title>
    <link rel="stylesheet" href="style.css" />
    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap"
      rel="stylesheet"
    />
  </head>
  <body>
    <div class="app-layout">
      <!-- Header -->
      <header class="header">
        <div class="container">
          <div class="header-content">
            <button class="back-button" onclick="goBack()">‚Üê</button>
            <a href="index.html" class="logo">
              <svg
                width="24"
                height="24"
                viewBox="0 0 24 24"
                fill="none"
                stroke="currentColor"
                stroke-width="2"
                style="margin-right: 8px"
              >
                <path d="M3 21h18l-9-18z" />
                <path d="M12 9v4" />
                <path d="M12 17h.01" />
              </svg>
              DermaDetect
            </a>
            <nav class="nav-icons">
              <div
                class="nav-icon theme-toggle"
                title="Toggle Theme"
                onclick="toggleTheme()"
              >
                <svg
                  width="20"
                  height="20"
                  viewBox="0 0 24 24"
                  fill="none"
                  stroke="currentColor"
                  stroke-width="2"
                  class="theme-icon-light"
                >
                  <circle cx="12" cy="12" r="5" />
                  <path
                    d="M12 1v2M12 21v2M4.22 4.22l1.42 1.42M18.36 18.36l1.42 1.42M1 12h2M21 12h2M4.22 19.78l1.42-1.42M18.36 5.64l1.42-1.42"
                  />
                </svg>
                <svg
                  width="20"
                  height="20"
                  viewBox="0 0 24 24"
                  fill="none"
                  stroke="currentColor"
                  stroke-width="2"
                  class="theme-icon-dark"
                  style="display: none"
                >
                  <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z" />
                </svg>
              </div>
            </nav>
          </div>
        </div>
      </header>

      <!-- Main Content -->
      <main class="main-content">
        <div class="container">
          <!-- Diagnosis Header -->
          <section class="diagnosis-header">
            <div class="diagnosis-status">
              <div class="status-indicator" id="statusIndicator">
                <div class="status-dot"></div>
                <span class="status-text">Analysis Complete</span>
              </div>
            </div>
            <h1 class="diagnosis-title" id="diagnosisTitle">ANALYZING...</h1>
            <div class="confidence-display">
              <div class="confidence-meter" id="confidenceMeter">
                <div class="confidence-progress" id="confidenceProgress"></div>
              </div>
              <p class="confidence-score" id="confidenceScore">
                Please wait...
              </p>
            </div>
          </section>

          <!-- Results Grid -->
          <section class="results-section">
            <!-- Top Section: Image Preview (Full Width) -->
            <div class="image-section">
              <div class="info-card image-preview-card">
                <h3 class="info-card-title">Analyzed Image</h3>
                <div class="image-preview-container">
                  <img
                    id="analyzedImage"
                    alt="Analyzed skin condition"
                    class="analyzed-image"
                  />
                  <div class="image-info">
                    <span class="image-date" id="imageDate"></span>
                    <span class="image-size" id="imageSize"></span>
                  </div>
                </div>
              </div>
            </div>

            <!-- Middle Section: Diagnosis Left, Treatment Right -->
            <div class="main-content-grid">
              <!-- Left Column: Diagnosis Details -->
              <div class="left-column">
                <div class="info-card diagnosis-card">
                  <div class="card-header">
                    <h3 class="info-card-title">
                      <svg
                        width="20"
                        height="20"
                        viewBox="0 0 24 24"
                        fill="none"
                        stroke="currentColor"
                        stroke-width="2"
                      >
                        <path d="M9 12l2 2 4-4" />
                        <path
                          d="M21 12c.552 0 1-.448 1-1V5c0-.552-.448-1-1-1H3c-.552 0-1 .448-1 1v6c0 .552.448 1 1 1h18z"
                        />
                        <path
                          d="M21 12v7c0 .552-.448 1-1 1H3c-.552 0-1-.448-1-1v-7"
                        />
                      </svg>
                      Diagnosis Details
                    </h3>
                    <div class="severity-badge" id="severityBadge">Unknown</div>
                  </div>
                  <div class="diagnosis-content" id="diagnosisContent">
                    <div class="loading-skeleton">
                      <div class="skeleton-line"></div>
                      <div class="skeleton-line"></div>
                      <div class="skeleton-line short"></div>
                    </div>
                  </div>
                </div>
              </div>

              <!-- Right Column: Treatment Recommendations -->
              <div class="right-column">
                <div class="info-card recommendations-card">
                  <div class="card-header">
                    <h3 class="info-card-title">
                      <svg
                        width="20"
                        height="20"
                        viewBox="0 0 24 24"
                        fill="none"
                        stroke="currentColor"
                        stroke-width="2"
                      >
                        <path
                          d="M9 11H5a2 2 0 0 0-2 2v3c0 1.1.9 2 2 2h4l5 4v-5.5M15 9.34V4a2 2 0 0 0-2-2c-1.11 0-2 .89-2 2v10l5-1.34z"
                        />
                      </svg>
                      Treatment Recommendations
                    </h3>
                    <div class="urgency-indicator" id="urgencyIndicator">
                      Standard Care
                    </div>
                  </div>
                  <div class="doctor-content" id="doctorContent">
                    <div class="loading-skeleton">
                      <div class="skeleton-line"></div>
                      <div class="skeleton-line"></div>
                      <div class="skeleton-line short"></div>
                    </div>
                  </div>
                </div>
              </div>
            </div>

            <!-- Bottom Section: Medical Disclaimer and Next Steps -->
            <div class="bottom-info-grid">
              <!-- Medical Disclaimer -->
              <div class="info-card disclaimer-card">
                <div class="card-header">
                  <h3 class="info-card-title">
                    <svg
                      width="20"
                      height="20"
                      viewBox="0 0 24 24"
                      fill="none"
                      stroke="currentColor"
                      stroke-width="2"
                    >
                      <path
                        d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"
                      />
                      <line x1="12" y1="9" x2="12" y2="13" />
                      <line x1="12" y1="17" x2="12.01" y2="17" />
                    </svg>
                    Medical Disclaimer
                  </h3>
                </div>
                <div class="disclaimer-content">
                  <div class="disclaimer-points">
                    <div class="disclaimer-point">
                      <div class="point-icon">‚ÑπÔ∏è</div>
                      <p>
                        <strong>AI Analysis Only:</strong> This is for
                        informational purposes and educational reference.
                      </p>
                    </div>
                    <div class="disclaimer-point">
                      <div class="point-icon">üë®‚Äç‚öïÔ∏è</div>
                      <p>
                        <strong>Professional Consultation Required:</strong>
                        Always consult a dermatologist for proper diagnosis.
                      </p>
                    </div>
                    <div class="disclaimer-point">
                      <div class="point-icon">‚öïÔ∏è</div>
                      <p>
                        <strong>Not a Substitute:</strong> This does not replace
                        professional medical advice or treatment.
                      </p>
                    </div>
                  </div>
                </div>
              </div>

              <!-- Recommended Next Steps -->
              <div class="info-card next-steps-card">
                <div class="card-header">
                  <h3 class="info-card-title">
                    <svg
                      width="20"
                      height="20"
                      viewBox="0 0 24 24"
                      fill="none"
                      stroke="currentColor"
                      stroke-width="2"
                    >
                      <path
                        d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z"
                      />
                    </svg>
                    Recommended Next Steps
                  </h3>
                </div>
                <div class="next-steps-content" id="nextStepsContent">
                  <div class="step-item">
                    <div class="step-number">1</div>
                    <div class="step-text">
                      Save this analysis for your records
                    </div>
                  </div>
                  <div class="step-item">
                    <div class="step-number">2</div>
                    <div class="step-text">
                      Schedule routine dermatologist checkup
                    </div>
                  </div>
                  <div class="step-item">
                    <div class="step-number">3</div>
                    <div class="step-text">
                      Monitor and track any changes over time
                    </div>
                  </div>
                  <div class="step-item">
                    <div class="step-number">4</div>
                    <div class="step-text">
                      Follow recommended care guidelines
                    </div>
                  </div>
                </div>
              </div>
            </div>

            <!-- Emergency Alert Card (if needed) -->
            <div class="emergency-section" style="display: none;">
              <div class="info-card emergency-card" id="emergencyCard">
                <div class="card-header emergency-header">
                  <h3 class="info-card-title">
                    <svg
                      width="20"
                      height="20"
                      viewBox="0 0 24 24"
                      fill="none"
                      stroke="currentColor"
                      stroke-width="2"
                    >
                      <circle cx="12" cy="12" r="10" />
                      <line x1="12" y1="8" x2="12" y2="12" />
                      <line x1="12" y1="16" x2="12.01" y2="16" />
                    </svg>
                    Urgent Medical Attention
                  </h3>
                  <div class="urgency-level">HIGH PRIORITY</div>
                </div>
                <div class="emergency-content">
                  <div class="emergency-message">
                    <p>
                      <strong
                        >This condition may require immediate medical
                        evaluation.</strong
                      >
                    </p>
                    <p>
                      We recommend scheduling an appointment with a
                      dermatologist as soon as possible.
                    </p>
                  </div>
                  <div class="emergency-actions">
                    <button
                      class="btn btn-emergency"
                      onclick="findNearbyHospitals()"
                    >
                      <svg
                        width="16"
                        height="16"
                        viewBox="0 0 24 24"
                        fill="none"
                        stroke="currentColor"
                        stroke-width="2"
                      >
                        <path
                          d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"
                        />
                        <circle cx="12" cy="10" r="3" />
                      </svg>
                      Find Nearby Specialists
                    </button>
                    <button
                      class="btn btn-outline emergency-call"
                      onclick="callEmergency()"
                    >
                      <svg
                        width="16"
                        height="16"
                        viewBox="0 0 24 24"
                        fill="none"
                        stroke="currentColor"
                        stroke-width="2"
                      >
                        <path
                          d="M22 16.92v3a2 2 0 0 1-2.18 2 19.79 19.79 0 0 1-8.63-3.07 19.5 19.5 0 0 1-6-6 19.79 19.79 0 0 1-3.07-8.67A2 2 0 0 1 4.11 2h3a2 2 0 0 1 2 1.72 12.84 12.84 0 0 0 .7 2.81 2 2 0 0 1-.45 2.11L8.09 9.91a16 16 0 0 0 6 6l1.27-1.27a2 2 0 0 1 2.11-.45 12.84 12.84 0 0 0 2.81.7A2 2 0 0 1 22 16.92z"
                        />
                      </svg>
                      Emergency Contact
                    </button>
                  </div>
                </div>
              </div>
            </div>

            <!-- Action Buttons Section -->
            <div class="action-buttons-container">
              <div class="primary-actions">
                <button
                  class="btn btn-primary large"
                  onclick="newAnalysis()"
                >
                  <svg
                    width="18"
                    height="18"
                    viewBox="0 0 24 24"
                    fill="none"
                    stroke="currentColor"
                    stroke-width="2"
                  >
                    <path
                      d="M3 7v10a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2V9a2 2 0 0 0-2-2H5a2 2 0 0 0-2-2z"
                    />
                    <path d="M8 5v4" />
                    <path d="M12 5v4" />
                    <path d="M16 5v4" />
                  </svg>
                  New Analysis
                </button>
                <button
                  class="btn btn-secondary large"
                  onclick="downloadReport()"
                >
                  <svg
                    width="18"
                    height="18"
                    viewBox="0 0 24 24"
                    fill="none"
                    stroke="currentColor"
                    stroke-width="2"
                  >
                    <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4" />
                    <polyline points="7,10 12,15 17,10" />
                    <line x1="12" y1="15" x2="12" y2="3" />
                  </svg>
                  Download Report
                </button>
              </div>
              </div>
            </div>
          </section>
        </div>
      </main>

      <!-- Footer -->
      <footer class="footer">
        <div class="container">
          <div class="previous-reports">
            <span>AI-Powered Skin Analysis</span>
            <span class="arrow">‚Ä¢</span>
            <span>Always consult a healthcare professional</span>
          </div>
        </div>
      </footer>
    </div>
    <script>
      // Enhanced diagnosis results loading with animations
      function loadDiagnosisResults() {
        const resultData = localStorage.getItem("diagnosisResult");
        const imageData = localStorage.getItem("imageBase64");

        if (!resultData) {
          showError("No diagnosis results found");
          return;
        }

        try {
          const result = JSON.parse(resultData);

          // Show uploaded image
          if (imageData) {
            displayAnalyzedImage(imageData);
          }

          // Update status indicator
          updateStatusIndicator(result.success);

          if (result.success) {
            // Animate confidence meter
            animateConfidenceMeter(result.confidence_percentage || 0);

            // Update diagnosis with animation
            setTimeout(() => updateDiagnosisContent(result), 500);
            setTimeout(() => updateDiagnosisTitle(result), 1000);
          } else {
            showError(result.error);
          }
        } catch (error) {
          console.error("Error parsing diagnosis results:", error);
          showError("Failed to load analysis results");
        }
      }

      function displayAnalyzedImage(imageData) {
        const img = document.getElementById("analyzedImage");
        const dateEl = document.getElementById("imageDate");
        const sizeEl = document.getElementById("imageSize");

        if (img && imageData) {
          img.src = imageData;
          img.style.opacity = "0";
          img.onload = function () {
            img.style.transition = "opacity 0.5s ease-in-out";
            img.style.opacity = "1";
          };

          if (dateEl) {
            dateEl.textContent = new Date().toLocaleDateString();
          }

          // Calculate approximate file size
          if (sizeEl) {
            const sizeKB = Math.round((imageData.length * 0.75) / 1024);
            sizeEl.textContent = `~${sizeKB} KB`;
          }
        }
      }

      function updateStatusIndicator(success) {
        const indicator = document.getElementById("statusIndicator");
        const statusDot = indicator.querySelector(".status-dot");
        const statusText = indicator.querySelector(".status-text");

        if (success) {
          statusDot.className = "status-dot success";
          statusText.textContent = "Analysis Complete";
        } else {
          statusDot.className = "status-dot error";
          statusText.textContent = "Analysis Failed";
        }
      }

      function animateConfidenceMeter(confidence) {
        const progress = document.getElementById("confidenceProgress");
        const scoreEl = document.getElementById("confidenceScore");

        if (progress && scoreEl) {
          // Animate progress bar
          progress.style.width = "0%";
          progress.style.transition = "width 2s cubic-bezier(0.4, 0, 0.2, 1)";

          setTimeout(() => {
            progress.style.width = confidence + "%";
          }, 100);

          // Animate confidence score
          let currentConfidence = 0;
          const increment = confidence / 50; // 50 frames for smooth animation
          const timer = setInterval(() => {
            currentConfidence += increment;
            if (currentConfidence >= confidence) {
              currentConfidence = confidence;
              clearInterval(timer);
            }
            scoreEl.textContent = `Confidence: ${Math.round(
              currentConfidence
            )}%`;
          }, 40);
        }
      }

      function updateDiagnosisTitle(result) {
        const diagnosisTitle = document.querySelector(".diagnosis-title");
        if (diagnosisTitle) {
          diagnosisTitle.style.opacity = "0";
          setTimeout(() => {
            diagnosisTitle.textContent = result.prediction
              .replace(/_/g, " ")
              .toUpperCase();
            diagnosisTitle.style.transition = "opacity 0.5s ease-in-out";
            diagnosisTitle.style.opacity = "1";
          }, 250);
        }
      }

      function updateDiagnosisContent(result) {
        const diagnosisContent = document.querySelector(".diagnosis-content");
        const doctorContent = document.querySelector(".doctor-content");
        const emergencyCard = document.getElementById("emergencyCard");
        const severityBadge = document.getElementById("severityBadge");
        const urgencyIndicator = document.getElementById("urgencyIndicator");

        if (result.diagnosis_info && diagnosisContent) {
          const info = result.diagnosis_info;

          // Update severity badge with appropriate styling
          if (severityBadge) {
            severityBadge.textContent = info.severity || "Unknown";
            severityBadge.className = `severity-badge ${getSeverityClass(
              info.severity
            )}`;
          }

          // Enhanced diagnosis content
          diagnosisContent.innerHTML = `
            <div class="diagnosis-details">
              <div class="detail-group">
                <div class="detail-label">Condition</div>
                <div class="detail-value">${info.name}</div>
              </div>
              <div class="detail-group">
                <div class="detail-label">Description</div>
                <div class="detail-value">${info.description}</div>
              </div>
              <div class="detail-group">
                <div class="detail-label">Confidence Level</div>
                <div class="detail-value">
                  <div class="confidence-badge ${getConfidenceClass(
                    result.confidence_percentage
                  )}">
                    ${result.confidence_percentage}%
                  </div>
                </div>
              </div>
            </div>
          `;

          // Enhanced recommendations
          if (doctorContent && info.symptoms && info.recommendations) {
            urgencyIndicator.textContent = getUrgencyLevel(info.severity);
            urgencyIndicator.className = `urgency-indicator ${getUrgencyClass(
              info.severity
            )}`;

            doctorContent.innerHTML = `
              <div class="recommendations-sections">
                <div class="symptoms-section">
                  <h4 class="section-title">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                      <path d="M9 12l2 2 4-4"/>
                      <circle cx="12" cy="12" r="10"/>
                    </svg>
                    Common Symptoms
                  </h4>
                  <ul class="symptoms-list">
                    ${info.symptoms
                      .map(
                        (symptom) => `<li class="symptom-item">${symptom}</li>`
                      )
                      .join("")}
                  </ul>
                </div>
                <div class="recommendations-section">
                  <h4 class="section-title">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                      <path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z"/>
                    </svg>
                    Treatment Recommendations
                  </h4>
                  <ul class="recommendations-list">
                    ${info.recommendations
                      .map(
                        (rec) => `<li class="recommendation-item">${rec}</li>`
                      )
                      .join("")}
                  </ul>
                </div>
              </div>
            `;
          }

          // Show emergency card for high-risk conditions
          if (shouldShowEmergencyCard(info.name, info.severity)) {
            emergencyCard.style.display = "block";
            emergencyCard.style.animation = "slideInUp 0.5s ease-out";
            updateNextSteps(info.name, true);
          } else {
            updateNextSteps(info.name, false);
          }

          // Add fade-in animation to all cards
          animateCards();
        }
      }

      function getSeverityClass(severity) {
        if (!severity) return "unknown";
        const sev = severity.toLowerCase();
        if (
          sev.includes("high") ||
          sev.includes("severe") ||
          sev.includes("urgent")
        )
          return "high";
        if (sev.includes("moderate") || sev.includes("medium")) return "medium";
        return "low";
      }

      function getConfidenceClass(confidence) {
        if (confidence >= 80) return "high";
        if (confidence >= 60) return "medium";
        return "low";
      }

      function getUrgencyLevel(severity) {
        if (!severity) return "Standard Care";
        const sev = severity.toLowerCase();
        if (
          sev.includes("high") ||
          sev.includes("severe") ||
          sev.includes("urgent")
        )
          return "Urgent Care";
        if (sev.includes("moderate") || sev.includes("medium"))
          return "Scheduled Care";
        return "Standard Care";
      }

      function getUrgencyClass(severity) {
        const urgency = getUrgencyLevel(severity).toLowerCase();
        if (urgency.includes("urgent")) return "urgent";
        if (urgency.includes("scheduled")) return "scheduled";
        return "standard";
      }

      function shouldShowEmergencyCard(conditionName, severity) {
        const emergencyConditions = [
          "melanoma",
          "basal cell carcinoma",
          "squamous cell carcinoma",
        ];
        const isEmergencyCondition = emergencyConditions.some((condition) =>
          conditionName.toLowerCase().includes(condition)
        );
        const isHighSeverity =
          severity &&
          (severity.toLowerCase().includes("high") ||
            severity.toLowerCase().includes("urgent") ||
            severity.toLowerCase().includes("severe"));

        return isEmergencyCondition || isHighSeverity;
      }

      function updateNextSteps(conditionName, isUrgent) {
        const nextStepsContent = document.getElementById("nextStepsContent");
        if (!nextStepsContent) return;

        const urgentSteps = `
          <div class="step-item urgent">
            <div class="step-number">1</div>
            <div class="step-text">Schedule immediate dermatologist consultation</div>
          </div>
          <div class="step-item">
            <div class="step-number">2</div>
            <div class="step-text">Save and print this analysis report</div>
          </div>
          <div class="step-item">
            <div class="step-number">3</div>
            <div class="step-text">Monitor for any rapid changes</div>
          </div>
          <div class="step-item">
            <div class="step-number">4</div>
            <div class="step-text">Follow all medical professional recommendations</div>
          </div>
        `;

        const normalSteps = `
          <div class="step-item">
            <div class="step-number">1</div>
            <div class="step-text">Save this analysis for your records</div>
          </div>
          <div class="step-item">
            <div class="step-number">2</div>
            <div class="step-text">Schedule routine dermatologist checkup</div>
          </div>
          <div class="step-item">
            <div class="step-number">3</div>
            <div class="step-text">Monitor and track any changes over time</div>
          </div>
          <div class="step-item">
            <div class="step-number">4</div>
            <div class="step-text">Follow recommended care guidelines</div>
          </div>
        `;

        nextStepsContent.innerHTML = isUrgent ? urgentSteps : normalSteps;
      }

      function animateCards() {
        const cards = document.querySelectorAll(".info-card");
        cards.forEach((card, index) => {
          card.style.opacity = "0";
          card.style.transform = "translateY(20px)";
          setTimeout(() => {
            card.style.transition =
              "opacity 0.5s ease-out, transform 0.5s ease-out";
            card.style.opacity = "1";
            card.style.transform = "translateY(0)";
          }, index * 150);
        });
      }

      function showError(message) {
        const diagnosisTitle = document.querySelector(".diagnosis-title");
        const confidenceScore = document.querySelector(".confidence-score");
        const diagnosisContent = document.querySelector(".diagnosis-content");

        updateStatusIndicator(false);

        if (diagnosisTitle) {
          diagnosisTitle.textContent = "ANALYSIS FAILED";
        }

        if (confidenceScore) {
          confidenceScore.textContent = "Unable to complete analysis";
        }

        if (diagnosisContent) {
          diagnosisContent.innerHTML = `
            <div class="error-content">
              <div class="error-icon">‚ö†Ô∏è</div>
              <h4>Analysis Error</h4>
              <p><strong>Error:</strong> ${message}</p>
              <p>Please try again with a different image or check that the server is running.</p>
              <button class="btn btn-outline" onclick="newAnalysis()" style="margin-top: 15px;">
                Try Again
              </button>
            </div>
          `;
        }
      }

      // Enhanced utility functions
      function findNearbyHospitals() {
        if (navigator.geolocation) {
          navigator.geolocation.getCurrentPosition(
            function (position) {
              const lat = position.coords.latitude;
              const lng = position.coords.longitude;
              window.open(
                `https://maps.google.com/?q=dermatologist+hospitals+near+${lat},${lng}`,
                "_blank"
              );
            },
            function () {
              // Fallback if location access is denied
              window.open(
                "https://maps.google.com/?q=dermatologist+hospitals+near+me",
                "_blank"
              );
            }
          );
        } else {
          window.open(
            "https://maps.google.com/?q=dermatologist+hospitals+near+me",
            "_blank"
          );
        }
      }

      function callEmergency() {
        if (
          confirm(
            "This will open your phone app to call emergency services. Are you experiencing a medical emergency?"
          )
        ) {
          window.open("tel:911", "_blank");
        }
      }

      function downloadReport() {
        const resultData = localStorage.getItem("diagnosisResult");
        if (resultData) {
          const result = JSON.parse(resultData);
          const reportContent = generateDetailedReport(result);

          const blob = new Blob([reportContent], { type: "text/plain" });
          const url = window.URL.createObjectURL(blob);
          const a = document.createElement("a");
          a.href = url;
          a.download = `skin-analysis-report-${
            new Date().toISOString().split("T")[0]
          }.txt`;
          a.click();
          window.URL.revokeObjectURL(url);

          // Show success message
          showNotification("Report downloaded successfully!", "success");
        } else {
          showNotification("No analysis data available to download", "error");
        }
      }

      function generateDetailedReport(result) {
        const date = new Date().toLocaleDateString();
        const time = new Date().toLocaleTimeString();

        return `
DermaDetect - AI ANALYSIS REPORT
========================================
Generated: ${date} at ${time}
Report ID: SHC-${Date.now()}

DIAGNOSIS INFORMATION
--------------------
Condition: ${result.prediction?.replace(/_/g, " ") || "Unknown"}
Confidence Level: ${result.confidence_percentage || 0}%
Severity: ${result.diagnosis_info?.severity || "Unknown"}

DESCRIPTION
-----------
${result.diagnosis_info?.description || "No description available"}

OBSERVED SYMPTOMS
-----------------
${
  result.diagnosis_info?.symptoms
    ? result.diagnosis_info.symptoms.map((s) => `‚Ä¢ ${s}`).join("\n")
    : "No symptoms listed"
}

TREATMENT RECOMMENDATIONS
-------------------------
${
  result.diagnosis_info?.recommendations
    ? result.diagnosis_info.recommendations.map((r) => `‚Ä¢ ${r}`).join("\n")
    : "Consult a healthcare professional"
}

IMPORTANT MEDICAL DISCLAIMER
============================
This AI analysis is provided for informational and educational purposes only.
It should NOT be used as a substitute for professional medical advice, 
diagnosis, or treatment.

ALWAYS seek the advice of a qualified healthcare provider with any questions
you may have regarding a medical condition. Never disregard professional 
medical advice or delay in seeking it because of something you have read 
in this report.

If you think you may have a medical emergency, call your doctor or emergency
services immediately.

NEXT STEPS
----------
1. Schedule an appointment with a dermatologist
2. Bring this report to your consultation
3. Monitor the condition for any changes
4. Follow all medical professional recommendations

---
Report generated by DermaDetect AI Analysis System
For questions or concerns, consult with a healthcare professional.
`;
      }

      function shareResults() {
        if (navigator.share) {
          const resultData = localStorage.getItem("diagnosisResult");
          if (resultData) {
            const result = JSON.parse(resultData);
            navigator.share({
              title: "Skin Analysis Results",
              text: `AI Skin Analysis: ${result.prediction?.replace(
                /_/g,
                " "
              )} (${
                result.confidence_percentage
              }% confidence). Remember to consult a healthcare professional.`,
              url: window.location.href,
            });
          }
        } else {
          // Fallback for browsers that don't support Web Share API
          const text =
            "Check out my skin analysis results from DermaDetect AI";
          navigator.clipboard.writeText(`${text} - ${window.location.href}`);
          showNotification("Link copied to clipboard!", "success");
        }
      }

      function saveToHistory() {
        const resultData = localStorage.getItem("diagnosisResult");
        if (resultData) {
          const result = JSON.parse(resultData);
          const historyEntry = {
            id: Date.now(),
            date: new Date().toISOString(),
            condition: result.prediction,
            confidence: result.confidence_percentage,
            severity: result.diagnosis_info?.severity,
            report: result,
          };

          let history = JSON.parse(
            localStorage.getItem("analysisHistory") || "[]"
          );
          history.unshift(historyEntry);

          // Keep only last 10 entries
          if (history.length > 10) {
            history = history.slice(0, 10);
          }

          localStorage.setItem("analysisHistory", JSON.stringify(history));
          showNotification("Analysis saved to history!", "success");
        }
      }

      function newAnalysis() {
        // Clear stored data
        localStorage.removeItem("uploadedImage");
        localStorage.removeItem("imageBase64");
        localStorage.removeItem("diagnosisResult");
        window.location.href = "index.html";
      }

      function showNotification(message, type = "info") {
        const notification = document.createElement("div");
        notification.className = `notification ${type}`;
        notification.textContent = message;

        notification.style.cssText = `
          position: fixed;
          top: 20px;
          right: 20px;
          padding: 12px 20px;
          border-radius: 8px;
          color: white;
          font-weight: 500;
          z-index: 10000;
          transform: translateX(100%);
          transition: transform 0.3s ease-out;
          ${
            type === "success"
              ? "background: #22c55e;"
              : type === "error"
              ? "background: #ef4444;"
              : "background: #3b82f6;"
          }
        `;

        document.body.appendChild(notification);

        setTimeout(() => {
          notification.style.transform = "translateX(0)";
        }, 100);

        setTimeout(() => {
          notification.style.transform = "translateX(100%)";
          setTimeout(() => document.body.removeChild(notification), 300);
        }, 3000);
      }

      // Load results when page loads
      document.addEventListener("DOMContentLoaded", function () {
        // Load saved theme
        loadSavedTheme();

        loadDiagnosisResults();

        // Add smooth scrolling for better UX
        document.documentElement.style.scrollBehavior = "smooth";
      });

      function goBack() {
        window.location.href = "page2.html";
      }

      // Theme toggle functionality
      function toggleTheme() {
        const body = document.body;
        const lightIcon = document.querySelector(".theme-icon-light");
        const darkIcon = document.querySelector(".theme-icon-dark");

        if (body.classList.contains("dark-theme")) {
          body.classList.remove("dark-theme");
          lightIcon.style.display = "block";
          darkIcon.style.display = "none";
          localStorage.setItem("theme", "light");
        } else {
          body.classList.add("dark-theme");
          lightIcon.style.display = "none";
          darkIcon.style.display = "block";
          localStorage.setItem("theme", "dark");
        }
      }

      // Load saved theme
      function loadSavedTheme() {
        const savedTheme = localStorage.getItem("theme");
        const lightIcon = document.querySelector(".theme-icon-light");
        const darkIcon = document.querySelector(".theme-icon-dark");

        if (savedTheme === "dark") {
          document.body.classList.add("dark-theme");
          if (lightIcon) lightIcon.style.display = "none";
          if (darkIcon) darkIcon.style.display = "block";
        } else {
          document.body.classList.remove("dark-theme");
          if (lightIcon) lightIcon.style.display = "block";
          if (darkIcon) darkIcon.style.display = "none";
        }
      }
    </script>
  </body>
</html>
