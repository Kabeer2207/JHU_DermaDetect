<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Diagnosis Results - Skin Health Center</title>
    <link rel="stylesheet" href="style.css" />
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet" />
  </head>
  <body>
    <div class="app-layout">
      <!-- Header -->
      <header class="header">
        <div class="container">
          <div class="header-content">
            <button class="back-button" onclick="goBack()">‚Üê</button>
            <a href="index.html" class="logo">
              <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="margin-right: 8px">
                <path d="M3 21h18l-9-18z" />
                <path d="M12 9v4" />
                <path d="M12 17h.01" />
              </svg>
              DermaDetect
            </a>
            <nav class="nav-icons">
              <div class="nav-icon theme-toggle" title="Toggle Theme" onclick="toggleTheme()">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" class="theme-icon-light">
                  <circle cx="12" cy="12" r="5" />
                  <path d="M12 1v2M12 21v2M4.22 4.22l1.42 1.42M18.36 18.36l1.42 1.42M1 12h2M21 12h2M4.22 19.78l1.42-1.42M18.36 5.64l1.42-1.42" />
                </svg>
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" class="theme-icon-dark" style="display: none">
                  <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z" />
                </svg>
              </div>
            </nav>
          </div>
        </div>
      </header>

      <!-- Main Content -->
      <main class="main-content">
        <div class="container">
          <!-- Diagnosis Header -->
          <section class="diagnosis-header">
            <div class="diagnosis-status">
              <div class="status-indicator" id="statusIndicator">
                <div class="status-dot"></div>
                <span class="status-text">Analysis Complete</span>
              </div>
            </div>
            <h1 class="diagnosis-title" id="diagnosisTitle">ANALYZING...</h1>
            <div class="confidence-display">
              <div class="confidence-meter">
                <div class="confidence-progress" id="confidenceProgress"></div>
              </div>
              <p class="confidence-score" id="confidenceScore">Please wait...</p>
            </div>
          </section>

          <!-- Results Grid -->
          <section class="results-section">
            <!-- Image Preview -->
            <div class="image-section">
              <div class="info-card image-preview-card">
                <h3 class="info-card-title">Analyzed Image</h3>
                <div class="image-preview-container">
                  <img id="analyzedImage" alt="Analyzed skin condition" class="analyzed-image" />
                  <div class="image-info">
                    <span class="image-date" id="imageDate"></span>
                    <span class="image-size" id="imageSize"></span>
                  </div>
                </div>
              </div>
            </div>

            <!-- Diagnosis & Treatment Grid -->
            <div class="main-content-grid">
              <!-- Left Column: Diagnosis + Symptoms -->
              <div class="left-column">
                <!-- Diagnosis Details -->
                <div class="info-card diagnosis-card">
                  <div class="card-header">
                    <h3 class="info-card-title">
                      <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M9 12l2 2 4-4" />
                        <circle cx="12" cy="12" r="10"/>
                      </svg>
                      Diagnosis Details
                    </h3>
                    <div class="severity-badge" id="severityBadge">Unknown</div>
                  </div>
                  <div class="diagnosis-content" id="diagnosisContent">
                    <div class="loading-skeleton">
                      <div class="skeleton-line"></div>
                      <div class="skeleton-line"></div>
                      <div class="skeleton-line short"></div>
                    </div>
                  </div>
                </div>

                <!-- Common Symptoms -->
                <div class="info-card symptoms-card">
                  <div class="card-header">
                    <h3 class="info-card-title">
                      <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M9 12l2 2 4-4"/>
                        <circle cx="12" cy="12" r="10"/>
                      </svg>
                      Common Symptoms
                    </h3>
                  </div>
                  <div class="symptoms-content" id="symptomsContent">
                    <div class="loading-skeleton">
                      <div class="skeleton-line"></div>
                      <div class="skeleton-line"></div>
                      <div class="skeleton-line short"></div>
                    </div>
                  </div>
                </div>
              </div>

              <!-- Right Column: Treatment Recommendations -->
              <div class="right-column">
                <div class="info-card recommendations-card">
                  <div class="card-header">
                    <h3 class="info-card-title">
                      <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M9 11H5a2 2 0 0 0-2 2v3c0 1.1.9 2 2 2h4l5 4v-5.5M15 9.34V4a2 2 0 0 0-2-2c-1.11 0-2 .89-2 2v10l5-1.34z" />
                      </svg>
                      Treatment Recommendations
                    </h3>
                    <div class="urgency-indicator" id="urgencyIndicator">Standard Care</div>
                  </div>
                  <div class="recommendations-content" id="recommendationsContent">
                    <div class="loading-skeleton">
                      <div class="skeleton-line"></div>
                      <div class="skeleton-line"></div>
                      <div class="skeleton-line short"></div>
                    </div>
                  </div>
                </div>
              </div>
            </div>

            <!-- Bottom Info Grid -->
            <div class="bottom-info-grid">
              <!-- Medical Disclaimer -->
              <div class="info-card disclaimer-card">
                <div class="card-header">
                  <h3 class="info-card-title">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                      <path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z" />
                      <line x1="12" y1="9" x2="12" y2="13" />
                      <line x1="12" y1="17" x2="12.01" y2="17" />
                    </svg>
                    Medical Disclaimer
                  </h3>
                </div>
                <div class="disclaimer-content">
                  <div class="disclaimer-points">
                    <div class="disclaimer-point">
                      <div class="point-icon">‚ÑπÔ∏è</div>
                      <p><strong>AI Analysis Only:</strong> For informational and educational purposes.</p>
                    </div>
                    <div class="disclaimer-point">
                      <div class="point-icon">üë®‚Äç‚öïÔ∏è</div>
                      <p><strong>Professional Consultation Required:</strong> Always consult a dermatologist.</p>
                    </div>
                    <div class="disclaimer-point">
                      <div class="point-icon">‚öïÔ∏è</div>
                      <p><strong>Not a Substitute:</strong> Does not replace professional medical advice.</p>
                    </div>
                  </div>
                </div>
              </div>

              <!-- Next Steps -->
              <div class="info-card next-steps-card">
                <div class="card-header">
                  <h3 class="info-card-title">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                      <path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z" />
                    </svg>
                    Recommended Next Steps
                  </h3>
                </div>
                <div class="next-steps-content" id="nextStepsContent">
                  <div class="step-item">
                    <div class="step-number">1</div>
                    <div class="step-text">Save this analysis for your records</div>
                  </div>
                  <div class="step-item">
                    <div class="step-number">2</div>
                    <div class="step-text">Schedule dermatologist checkup</div>
                  </div>
                  <div class="step-item">
                    <div class="step-number">3</div>
                    <div class="step-text">Monitor changes over time</div>
                  </div>
                  <div class="step-item">
                    <div class="step-number">4</div>
                    <div class="step-text">Follow recommended care guidelines</div>
                  </div>
                </div>
              </div>
            </div>

            <!-- Action Buttons -->
            <div class="action-buttons-container">
              <div class="primary-actions">
                <button class="btn btn-primary large" onclick="newAnalysis()">
                  <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M3 7v10a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2V9a2 2 0 0 0-2-2H5a2 2 0 0 0-2-2z" />
                    <path d="M8 5v4M12 5v4M16 5v4" />
                  </svg>
                  New Analysis
                </button>
                <button class="btn btn-secondary large" onclick="downloadReport()">
                  <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4" />
                    <polyline points="7,10 12,15 17,10" />
                    <line x1="12" y1="15" x2="12" y2="3" />
                  </svg>
                  Download Report
                </button>
              </div>
            </div>
          </section>
        </div>
      </main>

      <!-- Footer -->
      <footer class="footer">
        <div class="container">
          <div class="previous-reports">
            <span>AI-Powered Skin Analysis</span>
            <span class="arrow">‚Ä¢</span>
            <span>Always consult a healthcare professional</span>
          </div>
        </div>
      </footer>
    </div>

    <script>
      // Utility: Get CSS class based on severity/confidence
      function getStatusClass(value, type) {
        if (type === 'severity' || type === 'urgency') {
          const v = value.toLowerCase();
          if (v.includes('high') || v.includes('severe') || v.includes('urgent')) return 'high';
          if (v.includes('medium') || v.includes('moderate') || v.includes('scheduled')) return 'medium';
          return 'low';
        }
        if (type === 'confidence') {
          return value >= 80 ? 'high' : value >= 60 ? 'medium' : 'low';
        }
        return 'standard';
      }

      // Main: Load and display diagnosis results
      function loadDiagnosisResults() {
        const resultData = localStorage.getItem("diagnosisResult");
        const imageData = localStorage.getItem("imageBase64");

        if (!resultData) {
          showError("No diagnosis results found");
          return;
        }

        try {
          const result = JSON.parse(resultData);
          
          if (imageData) displayAnalyzedImage(imageData);
          updateStatusIndicator(result.success);

          if (result.success) {
            animateConfidence(result.confidence_percentage || 0);
            setTimeout(() => updateContent(result), 500);
          } else {
            showError(result.error);
          }
        } catch (error) {
          console.error("Error:", error);
          showError("Failed to load results");
        }
      }

      // Display uploaded image
      function displayAnalyzedImage(imageData) {
        const img = document.getElementById("analyzedImage");
        if (img && imageData) {
          img.src = imageData;
          img.style.opacity = "0";
          img.onload = () => {
            img.style.transition = "opacity 0.5s";
            img.style.opacity = "1";
          };
          
          const dateEl = document.getElementById("imageDate");
          const sizeEl = document.getElementById("imageSize");
          if (dateEl) dateEl.textContent = new Date().toLocaleDateString();
          if (sizeEl) sizeEl.textContent = `~${Math.round((imageData.length * 0.75) / 1024)} KB`;
        }
      }

      // Update status indicator
      function updateStatusIndicator(success) {
        const indicator = document.getElementById("statusIndicator");
        const dot = indicator.querySelector(".status-dot");
        const text = indicator.querySelector(".status-text");
        
        dot.className = success ? "status-dot success" : "status-dot error";
        text.textContent = success ? "Analysis Complete" : "Analysis Failed";
      }

      // Animate confidence meter
      function animateConfidence(confidence) {
        const progress = document.getElementById("confidenceProgress");
        const scoreEl = document.getElementById("confidenceScore");

        if (progress && scoreEl) {
          progress.style.width = "0%";
          progress.style.transition = "width 2s cubic-bezier(0.4, 0, 0.2, 1)";
          setTimeout(() => progress.style.width = confidence + "%", 100);

          let current = 0;
          const increment = confidence / 50;
          const timer = setInterval(() => {
            current += increment;
            if (current >= confidence) {
              current = confidence;
              clearInterval(timer);
            }
            scoreEl.textContent = `Confidence: ${Math.round(current)}%`;
          }, 40);
        }
      }

      // Update all diagnosis content
      function updateContent(result) {
        const info = result.diagnosis_info;
        if (!info) return;

        // Update title
        const title = document.querySelector(".diagnosis-title");
        if (title) {
          title.style.opacity = "0";
          setTimeout(() => {
            title.textContent = result.prediction.replace(/_/g, " ").toUpperCase();
            title.style.transition = "opacity 0.5s";
            title.style.opacity = "1";
          }, 250);
        }

        // Update severity badge
        const severityBadge = document.getElementById("severityBadge");
        if (severityBadge) {
          severityBadge.textContent = info.severity || "Unknown";
          severityBadge.className = `severity-badge ${getStatusClass(info.severity, 'severity')}`;
        }

        // Update diagnosis details
        const diagnosisContent = document.querySelector(".diagnosis-content");
        if (diagnosisContent) {
          diagnosisContent.innerHTML = `
            <div class="diagnosis-details">
              <div class="detail-group">
                <div class="detail-label">Condition</div>
                <div class="detail-value">${info.name}</div>
              </div>
              <div class="detail-group">
                <div class="detail-label">Description</div>
                <div class="detail-value">${info.description}</div>
              </div>
              <div class="detail-group">
                <div class="detail-label">Confidence Level</div>
                <div class="detail-value">
                  <div class="confidence-badge ${getStatusClass(result.confidence_percentage, 'confidence')}">
                    ${result.confidence_percentage}%
                  </div>
                </div>
              </div>
            </div>
          `;
        }

        // Update common symptoms (separate card)
        const symptomsContent = document.getElementById("symptomsContent");
        if (symptomsContent && info.symptoms) {
          symptomsContent.innerHTML = `
            <ul class="symptoms-list">
              ${info.symptoms.map(s => `<li class="symptom-item">${s}</li>`).join("")}
            </ul>
          `;
        }

        // Update urgency indicator
        const urgencyIndicator = document.getElementById("urgencyIndicator");
        if (urgencyIndicator) {
          const urgency = getStatusClass(info.severity, 'urgency') === 'high' ? 'Urgent Care' : 
                         getStatusClass(info.severity, 'urgency') === 'medium' ? 'Scheduled Care' : 'Standard Care';
          urgencyIndicator.textContent = urgency;
          urgencyIndicator.className = `urgency-indicator ${getStatusClass(urgency, 'urgency')}`;
        }

        // Update treatment recommendations (without symptoms)
        const recommendationsContent = document.getElementById("recommendationsContent");
        if (recommendationsContent && info.recommendations) {
          recommendationsContent.innerHTML = `
            <ul class="recommendations-list">
              ${info.recommendations.map(r => `<li class="recommendation-item">${r}</li>`).join("")}
            </ul>
          `;
        }

        // Animate cards
        document.querySelectorAll(".info-card").forEach((card, i) => {
          card.style.opacity = "0";
          card.style.transform = "translateY(20px)";
          setTimeout(() => {
            card.style.transition = "opacity 0.5s, transform 0.5s";
            card.style.opacity = "1";
            card.style.transform = "translateY(0)";
          }, i * 150);
        });
      }

      // Show error state
      function showError(message) {
        updateStatusIndicator(false);
        
        const title = document.querySelector(".diagnosis-title");
        const score = document.querySelector(".confidence-score");
        const content = document.querySelector(".diagnosis-content");

        if (title) title.textContent = "ANALYSIS FAILED";
        if (score) score.textContent = "Unable to complete analysis";
        if (content) {
          content.innerHTML = `
            <div class="error-content">
              <div class="error-icon">‚ö†Ô∏è</div>
              <h4>Analysis Error</h4>
              <p><strong>Error:</strong> ${message}</p>
              <p>Please try again with a different image.</p>
              <button class="btn btn-outline" onclick="newAnalysis()" style="margin-top: 15px;">Try Again</button>
            </div>
          `;
        }
      }

      // Download report
      function downloadReport() {
        const resultData = localStorage.getItem("diagnosisResult");
        if (!resultData) {
          alert("No analysis data available");
          return;
        }

        const result = JSON.parse(resultData);
        const date = new Date().toLocaleDateString();
        const time = new Date().toLocaleTimeString();

        const report = `
DermaDetect - AI Analysis Report
Generated: ${date} at ${time}

DIAGNOSIS
Condition: ${result.prediction?.replace(/_/g, " ") || "Unknown"}
Confidence: ${result.confidence_percentage || 0}%
Severity: ${result.diagnosis_info?.severity || "Unknown"}

DESCRIPTION
${result.diagnosis_info?.description || "No description available"}

SYMPTOMS
${result.diagnosis_info?.symptoms?.map(s => `‚Ä¢ ${s}`).join("\n") || "No symptoms listed"}

RECOMMENDATIONS
${result.diagnosis_info?.recommendations?.map(r => `‚Ä¢ ${r}`).join("\n") || "Consult a healthcare professional"}

MEDICAL DISCLAIMER
This AI analysis is for informational purposes only and should NOT replace 
professional medical advice. Always consult a qualified healthcare provider.

---
Report generated by DermaDetect AI Analysis System
`;

        const blob = new Blob([report], { type: "text/plain" });
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement("a");
        a.href = url;
        a.download = `dermadetect-report-${new Date().toISOString().split("T")[0]}.txt`;
        a.click();
        window.URL.revokeObjectURL(url);
      }

      // New analysis
      function newAnalysis() {
        localStorage.removeItem("uploadedImage");
        localStorage.removeItem("imageBase64");
        localStorage.removeItem("diagnosisResult");
        window.location.href = "index.html";
      }

      // Go back
      function goBack() {
        window.location.href = "page2.html";
      }

      // Theme toggle
      function toggleTheme() {
        const body = document.body;
        const lightIcon = document.querySelector(".theme-icon-light");
        const darkIcon = document.querySelector(".theme-icon-dark");

        body.classList.toggle("dark-theme");
        const isDark = body.classList.contains("dark-theme");
        
        if (lightIcon) lightIcon.style.display = isDark ? "none" : "block";
        if (darkIcon) darkIcon.style.display = isDark ? "block" : "none";
        localStorage.setItem("theme", isDark ? "dark" : "light");
      }

      // Load saved theme
      function loadSavedTheme() {
        const savedTheme = localStorage.getItem("theme");
        const lightIcon = document.querySelector(".theme-icon-light");
        const darkIcon = document.querySelector(".theme-icon-dark");

        if (savedTheme === "dark") {
          document.body.classList.add("dark-theme");
          if (lightIcon) lightIcon.style.display = "none";
          if (darkIcon) darkIcon.style.display = "block";
        }
      }

      // Initialize
      document.addEventListener("DOMContentLoaded", () => {
        loadSavedTheme();
        loadDiagnosisResults();
        document.documentElement.style.scrollBehavior = "smooth";
      });
    </script>
  </body>
</html>
